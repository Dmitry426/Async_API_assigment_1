{
  "film_work_pg": {
    "state_file_path": "./film_work_state.json",
    "limit": 1000,
    "film_work_state_field": "film_work_updated_at",
    "genres_state_field": "genres_updated_at",
    "persons_state_field": "persons_updated_at",
    "sql_query_film_work_by_id": "SELECT\n    fw.id as film_id, \n  fw.title, \n    fw.description, \n    fw.rating, \n     fw.updated_at as updated_at, \n    pfw.role, \n    p.id as person_id, \n    p.full_name,\n    g.name as genre , \n g.id as genre_id\n FROM content.film_work fw\nLEFT JOIN content.person_film_work pfw ON pfw.film_work_id = fw.id\nLEFT JOIN content.person p ON p.id = pfw.person_id\nLEFT JOIN content.genre_film_work gfw ON gfw.film_work_id = fw.id\nLEFT JOIN content.genre g ON g.id = gfw.genre_id\n WHERE fw.id IN %s ORDER BY updated_at ; ",
    "sql_query_film_work_by_updated_at": "SELECT\n    fw.id as film_id, \n    fw.title, \n    fw.description, \n    fw.rating, \n     fw.updated_at as updated_at, \n    pfw.role, \n    p.id as person_id, \n    p.full_name,\n    g.name as genre, \n g.id as genre_id \n FROM content.film_work fw\nLEFT JOIN content.person_film_work pfw ON pfw.film_work_id = fw.id\nLEFT JOIN content.person p ON p.id = pfw.person_id\nLEFT JOIN content.genre_film_work gfw ON gfw.film_work_id = fw.id\nLEFT JOIN content.genre g ON g.id = gfw.genre_id\n {} ",
    "sql_query_persons": "SELECT id, updated_at\nFROM content.person\n {}",
    "sql_query_person_film_work": "SELECT fw.id, fw.updated_at\nFROM content.film_work fw\nLEFT JOIN content.person_film_work pfw ON pfw.film_work_id = fw.id\nWHERE pfw.person_id IN %s \nORDER BY fw.updated_at\nLIMIT 1000; ",
    "sql_query_genres": " SELECT id , updated_at \n FROM content.genre \n {} ",
    "sql_query_genre_film_work": "SELECT fw.id , fw.updated_at \n FROM content.film_work fw \n LEFT JOIN content.genre_film_work gfw ON gfw.film_work_id = fw.id \n WHERE gfw.genre_id IN %s \n ORDER BY updated_at \n LIMIT 1000"
  },
  "person_pg": {
    "state_file_path": "./person_state.json",
    "limit": 1000,
    "order_field": "updated_at",
    "state_field": "updated_at",
    "producer_queries": [
      {
        "table": "film_work",
        "query": "SELECT DISTINCT content.person.id, fw.updated_at FROM content.person LEFT JOIN content.person_film_work pfw on person.id = pfw.person_id LEFT JOIN content.film_work fw on pfw.film_work_id = fw.id",
        "state_field": "fw.updated_at"
      },
      {
        "table": "person",
        "query": "SELECT id, updated_at FROM content.person",
        "state_field": "updated_at"
      },
      {
        "table": "genre",
        "query": "SELECT DISTINCT content.person.id, g.updated_at FROM content.person LEFT JOIN content.person_film_work pfw on person.id = pfw.person_id LEFT JOIN content.genre_film_work gfw ON pfw.film_work_id = gfw.film_work_id LEFT JOIN content.genre g ON gfw.genre_id = g.id",
        "state_field": "g.updated_at"
      }
    ],
    "enricher_query": "SELECT DISTINCT p.id, p.full_name, p.updated_at, array_agg(DISTINCT pfw.role) AS role, array_agg(DISTINCT jsonb_build_object('id', fw.id, 'name', fw.title, 'imdb_rating', fw.rating)) AS film_works FROM content.person AS p LEFT JOIN content.person_film_work pfw on p.id = pfw.person_id LEFT JOIN content.film_work fw on fw.id = pfw.film_work_id WHERE p.id IN {ids} GROUP BY p.id"
  },
  "genre_pg": {
    "state_file_path": "./genre_state.json",
    "limit": 1000,
    "order_field": "updated_at",
    "state_field": "updated_at",
    "producer_queries": [
      {
        "table": "film_work",
        "query": "SELECT DISTINCT content.genre.id, fw.updated_at FROM content.genre LEFT JOIN content.genre_film_work gfw ON genre.id = gfw.genre_id LEFT JOIN content.film_work fw ON gfw.film_work_id = fw.id",
        "state_field": "fw.updated_at"
      },
      {
        "table": "person",
        "query": "SELECT DISTINCT content.genre.id, p.updated_at FROM content.genre LEFT JOIN content.genre_film_work gfw ON genre.id = gfw.genre_id LEFT JOIN content.film_work fw ON gfw.film_work_id = fw.id LEFT JOIN content.person_film_work pfw ON fw.id = pfw.film_work_id LEFT JOIN content.person p ON pfw.person_id = p.id",
        "state_field": "p.updated_at"
      },
      {
        "table": "genre",
        "query": "SELECT DISTINCT id, updated_at FROM content.genre",
        "state_field": "updated_at"
      }
    ],
    "enricher_query": "SELECT g.id, g.name, g.updated_at, array_agg(DISTINCT jsonb_build_array('id', fw.id, 'title', fw.title, 'imdb_rating', fw.rating, 'genre', jsonb_build_array('id', fg.id, 'title', fg.name))) AS film_works FROM content.genre AS g LEFT JOIN content.genre_film_work gfw on g.id = gfw.genre_id LEFT JOIN content.film_work fw on fw.id = gfw.film_work_id LEFT JOIN content.genre_film_work w on fw.id = w.film_work_id LEFT JOIN content.genre fg on w.genre_id = fg.id WHERE g.id IN {ids} GROUP BY g.id;"
  }
}